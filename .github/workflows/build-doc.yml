name: Generate and Deploy Quarto Documentation

on:
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install OpenAI SDK (v0.28)
        run: pip install openai==0.28

      - name: ğŸ¤– Generate Quarto documentation with ChatGPT
        run: |
          mkdir -p site
          python3 <<EOF
          import openai, os
          openai.api_key = os.getenv("OPENAI_API_KEY")

          prompt = """
          ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ Fortran ã§è¨˜è¿°ã•ã‚ŒãŸæ•°å€¤è§£æã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã™ã€‚
          ä»¥ä¸‹ã®å†…å®¹ã«æ²¿ã£ã¦ã€Quartoå½¢å¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼šreborn_project2
          - æ¦‚è¦ï¼š2æ¬¡å…ƒæµã‚Œè§£æã€åœ°å½¢å¤‰åŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼šsrc/, lib/, nays2dh/
          - ä½¿ç”¨æ–¹æ³•ï¼šã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã¨å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š
          - å‡ºåŠ›ï¼šå¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã¨é€£æºå¯èƒ½ãªCGNSå‡ºåŠ›
          - é–‹ç™ºè€…å‘ã‘æƒ…å ±ï¼šãƒ“ãƒ«ãƒ‰æ‰‹é †ã€ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

          Markdownï¼ˆ.qmdï¼‰å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
          """

          res = openai.ChatCompletion.create(
              model="gpt-3.5-turbo",
              messages=[
                  {"role": "system", "content": "ã‚ãªãŸã¯æŠ€è¡“æ–‡æ›¸ã®å°‚é–€å®¶ã§ã™ã€‚"},
                  {"role": "user", "content": prompt}
              ]
          )

          content = res.choices[0].message.content

          with open("site/index.qmd", "w") as f:
              f.write(content)
          EOF

          # Create Quarto project config
          echo "project:
  type: website

format:
  html:
    toc: true
    theme: cosmo
" > site/quarto.yml
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: ğŸ§° Install Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: ğŸ— Render Quarto site
        run: |
          cd site
          quarto render .

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site/_site
          publish_branch: gh-pages
          force_orphan: true
