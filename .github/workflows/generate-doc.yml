name: Generate Documentation with ChatGPT

on:
  workflow_dispatch:

jobs:
  generate-doc:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Python ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install openai==0.28

      - name: ChatGPT ã‚’ä½¿ç”¨ã—ã¦ Quarto ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
        run: |
          python3 <<EOF
          import openai
          import os

          openai.api_key = os.getenv("OPENAI_API_KEY")

          prompt = """
          ä»¥ä¸‹ã® Fortran ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜æ›¸ã‚’ Quarto å½¢å¼ï¼ˆ.qmdï¼‰ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: reborn_project
          - æ¦‚è¦: Fortran è£½ã®æ•°å€¤è§£æã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
          - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ: src/, lib/, nays2dh/
          - ä¸»ãªæ©Ÿèƒ½: 2æ¬¡å…ƒæµã‚Œè§£æã€åœ°å½¢å¤‰åŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          - ä½¿ç”¨æ–¹æ³•: ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®å®Ÿè¡Œã€å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š
          - å‡ºåŠ›: çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã€å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã¨ã®é€£æº
          """

          response = openai.ChatCompletion.create(
              model="gpt-4",
              messages=[
                  {"role": "system", "content": "ã‚ãªãŸã¯æŠ€è¡“æ–‡æ›¸ã®å°‚é–€å®¶ã§ã™ã€‚"},
                  {"role": "user", "content": prompt}
              ]
          )

          content = response['choices'][0]['message']['content']

          os.makedirs("doc", exist_ok=True)
          with open("doc/user_guide.qmd", "w", encoding="utf-8") as f:
              f.write(content)
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Quarto ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Quarto ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ HTML ã«å¤‰æ›
        run: |
          cd doc
          quarto render user_guide.qmd --to html

      - name: GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./doc
          publish_branch: gh-pages
          force_orphan: true  # ğŸ’¡åˆå›ä½œæˆã§å¼·åˆ¶çš„ã«æ–°ãƒ–ãƒ©ãƒ³ãƒã«ã™ã‚‹
